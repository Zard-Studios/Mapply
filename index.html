<!DOCTYPE html>
<html lang="it">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description"
    content="Mapply ‚Äì App di mappe concettuali DSA-friendly. Crea, modifica e salva mappe mentali in modo semplice e accessibile.">
  <meta name="theme-color" content="#6366f1">

  <title>Mapply ‚Äì Mappe Concettuali</title>

  <!-- PWA Manifest -->
  <link rel="manifest" href="manifest.json">

  <!-- Fonts: Inter (DSA-friendly) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- Styles -->
  <link rel="stylesheet" href="styles/themes.css">
  <link rel="stylesheet" href="styles/main.css">
  <link rel="stylesheet" href="styles/canvas.css">
  <link rel="stylesheet" href="styles/nodes.css">
  <link rel="stylesheet" href="styles/context-menu.css">
  <link rel="stylesheet" href="styles/ai.css">
</head>

<body>
  <!-- =====================================================
       APP CONTAINER ‚Äì macOS Window Style
       ===================================================== -->
  <div id="app" class="app-container">

    <!-- -------------------------------------------------
         TOP BAR ‚Äì Traffic lights + Title + Actions
         ------------------------------------------------- -->
    <header class="top-bar">
      <!-- Decorative traffic lights (macOS style) -->
      <div class="traffic-lights" aria-hidden="true">
        <span class="light light-close"></span>
        <span class="light light-minimize"></span>
        <span class="light light-maximize"></span>
      </div>

      <!-- History Actions (Left) -->
      <div class="history-actions" style="margin-left: 12px; display: flex; gap: 4px;">
        <button id="btn-undo" class="btn-icon" aria-label="Annulla" title="Annulla (Cmd+Z)">
          <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M3 7v6h6" />
            <path d="M21 17a9 9 0 0 0-9-9 9 9 0 0 0-6 2.3L3 13" />
          </svg>
        </button>

        <button id="btn-redo" class="btn-icon" aria-label="Ripristina" title="Ripristina (Cmd+Shift+Z)">
          <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 7v6h-6" />
            <path d="M3 17a9 9 0 0 1 9-9 9 9 0 0 1 6 2.3L21 13" />
          </svg>
        </button>
      </div>

      <!-- Map title (editable) -->
      <div class="title-container">
        <h1 id="map-title" class="map-title" contenteditable="true" spellcheck="false">
          Nuova Mappa
        </h1>
      </div>

      <!-- Action buttons -->
      <div class="top-actions">
        <button id="btn-theme" class="btn-icon" aria-label="Cambia tema" title="Cambia tema">
          <svg class="icon icon-theme-light" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="5" />
            <path
              d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" />
          </svg>
          <svg class="icon icon-theme-dark" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" />
          </svg>
        </button>


        <button id="btn-save" class="btn-icon" aria-label="Salva mappa" title="Salva">
          <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z" />
            <polyline points="17 21 17 13 7 13 7 21" />
            <polyline points="7 3 7 8 15 8" />
          </svg>
        </button>

        <button id="btn-export" class="btn-icon" aria-label="Esporta JSON" title="Esporta">
          <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
            <polyline points="17 8 12 3 7 8" />
            <line x1="12" y1="3" x2="12" y2="15" />
          </svg>
        </button>

        <button id="btn-import" class="btn-icon" aria-label="Importa JSON" title="Importa">
          <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
            <polyline points="7 10 12 15 17 10" />
            <line x1="12" y1="15" x2="12" y2="3" />
          </svg>
        </button>

        <button id="btn-settings" class="btn-icon" title="Impostazioni" data-tooltip="Impostazioni">
          <svg viewBox="0 0 24 24" fill="none" class="icon" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="3"></circle>
            <path
              d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z">
            </path>
          </svg>
        </button>
      </div>
    </header>

    <!-- -------------------------------------------------
         MAIN LAYOUT ‚Äì Sidebars + Canvas
         ------------------------------------------------- -->
    <main class="main-layout">

      <!-- LEFT SIDEBAR ‚Äì Map List -->
      <aside id="sidebar-left" class="sidebar sidebar-left">
        <div class="sidebar-header">
          <h2>Le tue mappe</h2>
          <button id="btn-new-map" class="btn-small" aria-label="Nuova mappa">
            <svg class="icon-small" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="12" y1="5" x2="12" y2="19" />
              <line x1="5" y1="12" x2="19" y2="12" />
            </svg>
            Nuova
          </button>
        </div>
        <ul id="map-list" class="map-list">
          <!-- Map items will be injected here -->
        </ul>
      </aside>

      <!-- CANVAS AREA -->
      <div id="canvas-container" class="canvas-container">

        <!-- VIEWPORT (transforms nodes only) -->
        <div id="viewport" class="viewport">
          <!-- Nodes layer -->
          <div id="nodes-layer" class="nodes-layer">
            <!-- Nodes will be injected here -->
          </div>
        </div>

        <!-- SVG layer for connections (NOT transformed, uses screen coords) -->
        <svg id="connections-layer" class="connections-layer">
          <defs>
            <linearGradient id="connection-gradient" x1="0%" y1="0%" x2="100%" y2="0%">
              <stop offset="0%" style="stop-color: var(--accent)" />
              <stop offset="100%" style="stop-color: var(--accent-secondary)" />
            </linearGradient>
          </defs>
        </svg>


        <!-- Floating Action Buttons -->
        <div class="floating-actions">
          <button id="btn-ai-toggle" class="btn-floating btn-floating-secondary" aria-label="AI Assistant"
            title="Chiedi all'AI">
            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M12 2L14.5 9.5L22 12L14.5 14.5L12 22L9.5 14.5L2 12L9.5 9.5L12 2Z"></path>
            </svg>
          </button>
          <button id="btn-add-node" class="btn-floating" aria-label="Aggiungi nodo" title="Nuovo Nodo (Q)">
            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="12" y1="5" x2="12" y2="19" />
              <line x1="5" y1="12" x2="19" y2="12" />
            </svg>
          </button>
        </div>

        <!-- Zoom controls -->
        <div class="zoom-controls">
          <button id="btn-zoom-in" class="btn-icon" aria-label="Zoom in">
            <svg class="icon-small" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="11" cy="11" r="8" />
              <line x1="21" y1="21" x2="16.65" y2="16.65" />
              <line x1="11" y1="8" x2="11" y2="14" />
              <line x1="8" y1="11" x2="14" y2="11" />
            </svg>
          </button>
          <span id="zoom-level" class="zoom-level">100%</span>
          <button id="btn-zoom-out" class="btn-icon" aria-label="Zoom out">
            <svg class="icon-small" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="11" cy="11" r="8" />
              <line x1="21" y1="21" x2="16.65" y2="16.65" />
              <line x1="8" y1="11" x2="14" y2="11" />
            </svg>
          </button>
        </div>
      </div>

      </p>
  </div>
  </aside>

  </main>

  <!-- -------------------------------------------------
         TOAST NOTIFICATIONS
         ------------------------------------------------- -->
  <div id="toast-container" class="toast-container" aria-live="polite"></div>

  <!-- Custom Context Menu -->
  <div id="context-menu" class="context-menu">
    <div class="menu-item" data-action="add-node">
      <span class="menu-icon">
        <svg class="icon-small" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="12" y1="5" x2="12" y2="19" />
          <line x1="5" y1="12" x2="19" y2="12" />
        </svg>
      </span>
      Nuovo Nodo
    </div>

    <div class="divider"></div>

    <!-- Edit Group -->
    <div class="menu-item" data-action="cut" data-group="selection" style="display:none">
      <span class="menu-icon">
        <svg class="icon-small" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="6" cy="6" r="3" />
          <circle cx="6" cy="18" r="3" />
          <line x1="20" y1="4" x2="8.12" y2="15.88" />
          <line x1="14.47" y1="14.48" x2="20" y2="20" />
          <line x1="8.12" y1="8.12" x2="12" y2="12" />
        </svg>
      </span>
      Taglia
    </div>
    <div class="menu-item" data-action="copy" data-group="selection" style="display:none">
      <span class="menu-icon">
        <svg class="icon-small" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="9" y="9" width="13" height="13" rx="2" ry="2" />
          <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1" />
        </svg>
      </span>
      Copia
    </div>
    <div class="menu-item" data-action="duplicate" data-group="selection" style="display:none">
      <span class="menu-icon">
        <svg class="icon-small" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="9" y="9" width="13" height="13" rx="2" ry="2" />
          <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1" />
        </svg>
      </span>
      Duplica
    </div>
    <div class="menu-item" data-action="paste">
      <span class="menu-icon">
        <svg class="icon-small" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2" />
          <rect x="8" y="2" width="8" height="4" rx="1" ry="1" />
        </svg>
      </span>
      Incolla
    </div>

    <div class="divider"></div>

    <!-- Selection Group -->
    <div class="menu-item" data-action="select-all">
      <span class="menu-icon">
        <svg class="icon-small" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M3 3h7v7H3z" />
          <path d="M14 3h7v7h-7z" />
          <path d="M14 14h7v7h-7z" />
          <path d="M3 14h7v7H3z" />
        </svg>
      </span>
      Seleziona Tutto
    </div>
    <div class="menu-item" data-action="delete" data-group="selection" style="display:none; color: var(--destructive);">
      <span class="menu-icon" style="color: var(--destructive);">
        <svg class="icon-small" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="3 6 5 6 21 6" />
          <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" />
          <line x1="10" y1="11" x2="10" y2="17" />
          <line x1="14" y1="11" x2="14" y2="17" />
        </svg>
      </span>
      Elimina
    </div>

    <div class="divider"></div>

    <div class="menu-item" data-action="reset-view">
      <span class="menu-icon">
        <svg class="icon-small" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M15 3h6v6" />
          <path d="M9 21H3v-6" />
          <path d="M21 3l-7 7" />
          <path d="M3 21l7-7" />
        </svg>
      </span>
      Reset Vista
    </div>
  </div>

  </div>

  <!-- Settings Modal -->
  <div id="settings-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Impostazioni</h3>
        <button class="btn-close">&times;</button>
      </div>
      <div class="modal-body">
        <div class="setting-group">
          <label for="ai-api-key">OpenRouter API Key</label>
          <div class="input-wrapper">
            <input type="password" id="ai-api-key" placeholder="sk-or-..." />
            <button id="btn-toggle-visibility" class="btn-icon-small">üëÅÔ∏è</button>
          </div>
          <p class="help-text">Ottieni una key su <a href="https://openrouter.ai" target="_blank">openrouter.ai</a></p>
        </div>
        <div class="setting-group">
          <label for="ai-model">Modello AI Predeterminato</label>
          <select id="ai-model">
            <option value="google/gemini-flash-1.5">Google Gemini Flash 1.5 (Veloce/Economico)</option>
            <option value="google/gemini-pro-1.5">Google Gemini Pro 1.5 (Bilanciato)</option>
            <option value="openai/gpt-4o">OpenAI GPT-4o (Potente)</option>
            <option value="anthropic/claude-3.5-sonnet">Anthropic Claude 3.5 Sonnet (Creativo)</option>
            <option value="meta-llama/llama-3-8b-instruct">Llama 3 8B (Free)</option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button id="btn-save-settings" class="btn-primary">Salva</button>
      </div>
    </div>
  </div>

  <!-- AI Panel -->
  <div id="ai-panel" class="ai-panel">
    <div class="ai-header">
      <h3>Chiedi all'AI</h3>
      <button id="btn-close-ai" class="btn-icon">&times;</button>
    </div>
    <div id="ai-messages" class="ai-messages">
      <div class="ai-message system">
        Descrivi un argomento e generer√≤ una mappa per te.
        Puoi anche trascinare un PDF o un'immagine qui!
      </div>
    </div>
    <div class="ai-input-area">
      <div id="drop-zone" class="drop-zone hidden">
        <div class="drop-content">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
            <polyline points="17 8 12 3 7 8" />
            <line x1="12" y1="3" x2="12" y2="15" />
          </svg>
          <span>Rilascia file qui</span>
        </div>
      </div>
      <div class="input-row">
        <textarea id="ai-prompt" placeholder="Descrivi un argomento..." rows="1"></textarea>
        <button id="btn-send-ai" title="Invia">
          <svg viewBox="0 0 24 24" fill="currentColor">
            <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z" />
          </svg>
        </button>
      </div>
    </div>
  </div>

  <!-- Hidden file input for import -->
  <input type="file" id="file-import" accept=".json" hidden>

  <!-- Scripts (ES modules) -->
  <script type="module" src="js/app.js"></script>
</body>

</html>